<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>TreeVis Blue Noise Test</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        canvas {
          display: inline-block;
          width: 44%;
          height: 80%;
          margin: 2.5%;
        }
        #chartWhiteNoise {
          background: lightgrey;
        }
        #chartBlueNoise {
          background: skyblue;
        }
    </style>
  </head>
  <body>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"> </script>
    <canvas id="chartWhiteNoise"></canvas>
    <canvas id="chartBlueNoise"></canvas>

    <script src="https://cdn.jsdelivr.net/gh/kchapelier/fast-2d-poisson-disk-sampling@1.0.3/build/fast-poisson-disk-sampling.min.js"></script>

    <script type="module">

      import bluenoise from "./bluenoise.js";

      const canvasWhiteNoise = document.getElementById("chartWhiteNoise");
      const canvasBlueNoise = document.getElementById("chartBlueNoise");

      const ctxWhite = canvasWhiteNoise.getContext("2d");
      const ctxBlue = canvasBlueNoise.getContext("2d");

      canvasWhiteNoise.width = canvasWhiteNoise.clientWidth;
      canvasWhiteNoise.height = canvasWhiteNoise.clientHeight;
      canvasBlueNoise.width = canvasBlueNoise.clientWidth;
      canvasBlueNoise.height = canvasBlueNoise.clientHeight;

      const dotSizeWhite = Math.min(canvasWhiteNoise.width, canvasWhiteNoise.height) / 100;
      const dotSizeBlue = Math.min(canvasBlueNoise.width, canvasBlueNoise.height) / 100;

      const numPoints = 10000;

      for (let i = 0; i < numPoints; ++i) {
        const x = Math.random() * canvasWhiteNoise.width;
        const y = Math.random() * canvasWhiteNoise.height;
        
        // Draw a black round dot centered at (x, y)
        ctxWhite.fillStyle = "black";
        ctxWhite.beginPath();
        ctxWhite.arc(x, y, dotSizeWhite / 2, 0, 2 * Math.PI);
        ctxWhite.fill();
      }

      const bluePositions = bluenoise(canvasBlueNoise.width, canvasBlueNoise.height, numPoints);

      if (bluePositions.length < numPoints) {
          console.error("Too few points generated by blue noise algorithm. Only " + bluePositions.length + " points generated. instead of " + numPoints + ".", bluePositions);
      }

      for (let i = 0; i < Math.min(numPoints, bluePositions.length); ++i) {
        const x = bluePositions[i][0];
        const y = bluePositions[i][1];
        
        // Draw a black round dot centered at (x, y)
        ctxBlue.fillStyle = "black";
        ctxBlue.beginPath();
        ctxBlue.arc(x, y, dotSizeBlue / 2, 0, 2 * Math.PI);
        ctxBlue.fill();
      }

      /*const xValues = [];
      const yValues_elapsedMs = [];
      const yValues_avgElapsedMs = [];
      const chart = new Chart("chart", {
        type: "line",
        data: {
          labels: xValues,
          datasets: [
            {
              fill: false,
              label: "Elapsed Time (ms)",
              data: yValues_elapsedMs,
              borderColor: "red"
            },
            {
              fill: false,
              label: "Average Elapsed Time (ms)",
              data: yValues_avgElapsedMs,
              borderColor: "blue"
            }
          ]
        },
        options: {
          legend: { display: true },
          responsive: true,
          maintainAspectRatio: false,
        }
      });
      let yValues_sum = 0;
      let yValues_avg = null;
      const appendToChart = (elapsedMs) => {
        yValues_sum += elapsedMs;
        yValues_avg = yValues_sum / xValues.length;

        xValues.push(xValues.length + 1);
        yValues_elapsedMs.push(elapsedMs);
        yValues_avgElapsedMs.push(yValues_avg);

        chart.update();
      }

      const howMany = 100;
      let messageId = 0;
      const message = "spruce.glb";
      let start = null;
      const sendMessage = () => {
          start = performance.now();
          socket.send(message);
      };
      
      const socket = new WebSocket("ws://localhost:8080");
      socket.onerror = () => {
        alert("Error connecting to server. Please make sure the server is running.");
      };
      socket.addEventListener("open", (event) => {
        sendMessage();
      });
      socket.addEventListener("message", (message) => {
        const end = performance.now();
        const elapsed = end - start;

        if (messageId < howMany) {
          //console.log(`Model ${messageId} took ${elapsed} ms to be transferred from server to client.`);
          appendToChart(elapsed);
        }

        if (messageId++ < howMany) {
          sendMessage();
        }
      });*/

    </script>
  </body>
</html>